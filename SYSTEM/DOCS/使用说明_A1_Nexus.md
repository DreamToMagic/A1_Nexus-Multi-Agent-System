# A1_Nexus_Improved 自动调度系统使用说明书

欢迎使用升级版的 **A1_Nexus_Improved** 自动调度系统！
本系统专为解决大模型“上下文短、容易遗忘、逻辑断层”的问题而设计，通过“小步快跑、文件接力”的微指令架构，实现多角色 AI 协同工作。

---

## 🌟 核心升级亮点

1. **修复“归档死锁”**：P9 归档后的任务不再会导致后续任务卡死，依赖链条完美闭环。
2. **新增全自动模式 (`--auto`)**：支持无人值守挂机运行，AI 自动接力完成所有任务。
3. **更智能的文件名解析**：即使忘记写 `[NEW]` 标签，系统也能自动识别并处理。
4. **更精准的角色匹配**：彻底解决同级别角色卡（如 P8_技术 vs P8_文案）混淆的问题。

---

## 🚀 快速开始

### 1. 环境准备
确保您已安装 Python 3.8+，并安装了必要的依赖：
```bash
cd A1_Nexus_Improved
python auto_setup.py
```

### 2. 配置 API Key
打开 `config.yaml` 文件，填入您的 API Key：
```yaml
api_providers:
  providers:
    deepseek:
      api_key: "YOUR_DEEPSEEK_API_KEY" # 替换为您的真实 Key
      base_url: "https://api.deepseek.com/v1"
```

### 3. 启动系统

**模式一：交互审批模式（推荐用于核心代码/关键剧情）**
系统会在每个任务完成后暂停，让您（董事长）审批 AI 的产出。
```bash
python nexus_core.py
```

**模式二：全自动挂机模式（推荐用于海量重复性任务，如批量生成剧情）**
系统会自动选择任务、自动调用模型、自动保存结果，直到所有任务完成。
```bash
python nexus_core.py --auto
```

---

## 📝 任务下发规范 (给董事长的指南)

要让系统运转，您只需要在 `MESSAGES/` 目录下创建 Markdown 文件。

### 文件命名规则
格式：`[状态]发送者_TO_接收者_ID编号_简短描述.md`
*   **状态**：`[NEW]` (新任务), `[DONE]` (已完成), `[FAIL]` (失败)。*注：新版已支持省略 `[NEW]`。*
*   **发送者**：通常是 `P1` (项目经理) 或 `董事长`。
*   **接收者**：必须与 `PERSONAS/` 目录下的角色卡名称对应（如 `P8_技术`）。
*   **ID编号**：必须包含 `ID` + 数字（如 `ID001`），用于依赖追踪。

**正确示例：**
*   `[NEW]P1_TO_P8_技术_ID001_搭建框架.md`
*   `董事长_TO_P8_文案_ID002_编写第一章.md` (省略了 [NEW]，系统会自动识别)

### 文件内容规范
文件内容必须包含 `DEPENDS_ON:` 字段，用于声明前置任务。

**模板示例：**
```markdown
# 任务：编写第一章剧情

**DEPENDS_ON: ID001**  <-- 关键！表示必须等 ID001 完成后才能执行本任务。如果没有依赖，写 NONE。

## 任务背景
根据《世界观设定》，我们需要...

## 具体要求
1. 包含 3 个分支选项。
2. 输出格式必须为 JSON。
```

---

## 👥 角色卡 (Persona) 管理

所有的 AI 角色设定都存放在 `PERSONAS/` 目录下。

### 匹配规则（优先级从高到低）：
1. **完全精确匹配**：如果任务接收者是 `P8_技术`，系统会优先寻找 `P8_技术.md`。
2. **前缀匹配**：如果找不到，会寻找以 `P8_技术_` 开头的文件。
3. **级别通用匹配**：如果还找不到，会寻找同级别的通用卡，如 `P7_执行层_通用.md`。

**如何新增角色？**
直接在 `PERSONAS/` 目录下新建一个 Markdown 文件（例如 `P8_美术主管.md`），在里面写上该角色的 Prompt 设定即可。

---

## 🔄 完整工作流演示

1. **董事长下发总任务**：修改 `任务下发模板_给P1.md`，描述您的宏大目标。
2. **P1 拆解任务**：运行系统，P1 会将总任务拆解成多个子任务文件，存入 `MESSAGES/`。
3. **P7/P8 执行任务**：系统根据依赖关系（DAG），依次唤醒对应的 P7/P8 角色执行具体工作。
4. **P9 审计归档**：任务完成后（状态变为 `[DONE]`），P9 会自动将其移入 `ARCHIVE/` 目录，保持工作区整洁。

---

## ❓ 常见问题 (FAQ)

**Q: 为什么任务一直显示“等待前置依赖完成”？**
A: 请检查该任务的 `DEPENDS_ON:` 字段。确保它依赖的 ID 确实存在，并且该前置任务已经变成了 `[DONE]` 状态（或者已经被 P9 移入了 `ARCHIVE/` 目录）。

**Q: 自动模式下，AI 写错了怎么办？**
A: 自动模式追求效率。如果发现错误，您可以去 `MESSAGES/` 或 `ARCHIVE/` 找到对应的文件，手动修改内容，或者把文件名改回 `[NEW]` 让 AI 重做。

**Q: 如何更换模型？**
A: 在 `config.yaml` 中修改 `default` 提供商，或者在 `role_overrides` 中为特定角色指定模型（例如让 P8_文案 使用 Claude，让 P8_技术 使用 DeepSeek）。交互模式下，每次执行前也可以手动切换。